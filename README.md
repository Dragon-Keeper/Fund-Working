# 基金数据获取与管理系统

## 项目概述

本项目是一个全面的基金数据获取、存储与管理系统，旨在为投资者提供从东方财富网等数据源获取各类基金数据的功能，并将数据存储在HDF5文件中以便后续查询和分析。系统支持开放式基金、封闭式基金、货币基金和场内交易基金等多种基金类型的数据获取和管理，同时还提供通达信数据转换和HDF5数据分析功能。

## 功能模块

### 0. 基金基本信息及申购状态管理系统 (Fund_Purchase_Status_Manager.py)

#### 功能概述
全面管理基金基本信息和申购状态数据，支持多线程下载、增量更新和快速查询功能。

#### 主要功能
- **基金基本信息下载**：多线程获取所有基金的基本信息（代码、名称、类型等）
- **基金申购状态下载**：多线程获取基金的申购状态、赎回状态等详细信息
- **全量数据获取**：一次性下载并更新所有基金数据（基本信息+申购状态）
- **增量更新机制**：通过数据哈希比对，智能判断数据是否需要更新，避免重复下载
- **快速基金查询**：支持按基金代码查询基本信息和申购状态
- **友好的菜单界面**：清晰的命令行交互界面，操作简单直观

#### 实现细节
系统使用akshare库获取基金数据，采用ThreadPoolExecutor实现多线程下载，使用pandas处理数据，并存储在HDF5文件中。增量更新通过计算数据哈希值实现，提高数据更新效率。

#### 使用方法
1. 安装依赖：`pip install pandas numpy akshare tables`
2. 运行：`python Fund_Purchase_Status_Manager.py`
3. 菜单操作：
   - 选择1：下载基金基本信息（多线程）
   - 选择2：下载基金申购状态数据（多线程）
   - 选择3：下载所有基金基本信息和申购状态数据（多线程+增量更新）- 适合初始数据获取或完全更新
   - 选择4：查询基金基本信息
   - 选择5：查询基金申购状态
   - 选择0：退出系统

### 1. 通达信基金数据转HDF5工具 (TDX_To_HDF5.py)

#### 功能概述
通达信基金数据转HDF5工具用于将通达信软件生成的.day格式基金数据文件转换并存储到HDF5数据库中。该工具采用多线程并发处理、内存映射技术和批量写入优化，能够快速处理大量基金数据文件，实现从原始格式到高效查询格式的转换。

#### 实现细节
主要功能包括：

- 自动检测并安装必要的依赖
- 获取系统信息并动态计算最优线程数和批量大小
- 使用内存映射技术高效解析.day文件
- 多线程并行处理多个数据文件
- 流式处理和批量写入数据到HDF5文件
- 实现断点续传功能，记录处理状态
- 提供详细的进度显示和错误处理

#### 使用方法
直接运行程序：`python TDX_To_HDF5.py`，然后根据提示输入相关参数：

1. 最小日期（可选）：格式为YYYYMMDD，用于筛选数据，直接回车则提取所有数据
2. 线程数模式：
   - 选择1：使用单线程处理
   - 选择2：auto自动计算最佳线程数
   - 选择3：退出程序

系统将自动处理通达信.day文件并将数据存储为HDF5格式。

#### 参数说明

- **source_dir**：通达信.day文件所在目录，默认为D:\SoftWare\TDX\vipdoc\ds\lday
- **storage_file**：HDF5存储文件路径，默认为当前目录下的data/All_Fund_Data.h5
- **min_date**：可选的最小日期，用于过滤数据
- **线程数模式**：通过菜单选择
  - 选择1：使用单线程处理
  - 选择2：auto自动计算最佳线程数
  - 选择3：退出程序

#### 注意事项

1. 确保通达信软件已安装并下载了基金历史数据
2. 如果修改了source_dir，请确保指向正确的.day文件目录
3. 大批量数据处理可能需要一定时间，请耐心等待
4. 系统具有断点续传功能，可在意外中断后继续处理
5. 处理状态会保存到cache目录，便于恢复
6. 错误文件信息会记录到cache/errors目录

### 2. 基金HDF5数据读取与分析系统 (Read_HDF5_Data.py)

#### 功能概述
基金HDF5数据读取与分析系统用于从HDF5文件中高效读取、处理和分析基金历史净值数据。该系统提供了全面的数据查询、统计分析、可视化展示和数据导出功能，帮助用户深入了解基金的历史表现和趋势。

#### 实现细节
主要功能包括：

- 自动检测并安装必要的依赖
- 基金数据的高效读取（使用向量化操作）
- 预计算常用统计指标（最高净值、最低净值、平均净值、标准差、年化收益率等）
- 交互式净值走势图创建（支持线图、K线图、OHLC图）
- 交互式统计分析图创建（月度收益率分布、净值分布、涨跌幅分布等）
- 数据导出功能（支持CSV和Excel格式）
- 缓存机制优化性能

#### 使用方法
直接运行程序：`python Read_HDF5_Data.py`，然后在主菜单中选择所需功能：

- 选择1：显示指定基金的历史净值数据概览
- 选择2：显示指定基金在某一天的数据
- 选择3：显示指定基金的交互式净值走势图
- 选择4：显示指定基金的统计分析图
- 选择5：导出指定基金的数据为CSV文件
- 选择6：导出指定基金的数据为Excel文件
- 选择7：显示所有基金代码
- 选择0：退出系统

### 3. 基金数据爬取与HDF5存储系统 (Fetch_Fund_Data.py)

#### 功能概述
基金数据爬取与HDF5存储系统提供了一个从东方财富网爬取基金数据并将其存储到HDF5数据库的完整解决方案。系统支持多线程并行爬取、错误处理、数据验证和高效存储，能够快速获取并保存大量基金的最新净值、累计净值、日增长率等关键数据。

#### 实现细节
主要功能包括：

- 自动获取总页数：系统会自动从东方财富网获取基金数据的总页数
- 多线程并行爬取：使用线程池提高爬取效率，线程数可自定义
- 断点续爬与重试机制：当遇到网络问题时，会自动重试，避免数据丢失
- 进度显示：实时显示爬取进度、成功失败页数和耗时
- 智能解析：从页面HTML中提取基金数据，包括基金代码、名称、净值、增长率等
- 数据清洗：处理缺失值和格式不一致的数据
- 数据类型转换：将字符串数据转换为适当的数值类型
- HDF5格式存储：使用高效的HDF5格式存储数据，支持快速读写
- 按基金代码组织：数据按基金代码分类存储，便于后续查询
- 元数据记录：存储基金的各种属性信息和更新时间
- 增量更新：支持对已有基金数据进行更新
- 数据验证：验证爬取数据的数量和质量，提供统计信息

#### 使用方法
1. **完整爬取模式**：运行主程序，爬取所有页面的基金数据
   ```
   python Fetch_Fund_Data.py
   ```

2. **数据存储位置**：爬取的基金数据会存储在`data/Fund_NAV.h5`文件中

#### 数据字段说明

系统会爬取并存储以下基金数据字段：

| 字段名 | 说明 | 数据类型 |
|-------|------|---------|
| fund_code | 基金代码 | 字符串 |
| fund_name | 基金名称 | 字符串 |
| current_unit_nav | 最新交易日单位净值 | 浮点数 |
| current_accumulated_nav | 最新交易日累计净值 | 浮点数 |
| previous_unit_nav | 上一交易日单位净值 | 浮点数 |
| previous_accumulated_nav | 上一交易日累计净值 | 浮点数 |
| daily_growth_value | 日增长值 | 浮点数 |
| daily_growth_rate | 日增长率 | 浮点数 |
| purchase_status | 申购状态 | 字符串 |
| redemption_status | 赎回状态 | 字符串 |
| actual_fee_rate | 实际手续费率 | 字符串 |
| original_fee_rate | 原始手续费率 | 字符串 |
| current_date | 最新交易日日期 | 字符串 |
| previous_date | 上一交易日日期 | 字符串 |
| last_updated | 数据更新时间 | 字符串 |

### 4. 开放式基金排名数据获取 (fetch_open_fund_ranking.py)

#### 功能概述
从东方财富网获取开放式基金的排名数据，包括收益率、净值等信息，并支持将数据存储到HDF5文件中进行查询。

#### 主要功能
- 通过API获取开放式基金排名数据
- 支持按不同时间周期（日、周、月、年等）的收益率数据
- 将数据存储到HDF5文件中
- 提供按基金代码查询功能
- 命令行菜单界面，方便用户操作

#### 实现细节
系统使用requests库发送HTTP请求获取数据，使用正则表达式解析响应内容，提取基金数据。数据以基金代码为索引存储在HDF5文件中。

#### 使用方法
1. 安装依赖：`pip install requests pandas h5py`
2. 运行 `python fetch_open_fund_ranking.py`
3. 按照菜单提示选择下载或查询功能

### 5. 封闭式基金排名数据获取 (fetch_fbs_fund_ranking.py)

#### 功能概述
从东方财富网获取封闭式基金的排名数据，包括净值、折价率等信息，并支持将数据存储到HDF5文件中进行查询。

#### 主要功能
- 使用Playwright自动化浏览器获取封闭式基金排名数据
- 支持分页获取多页数据
- 将数据存储到HDF5文件中
- 提供按基金代码查询功能
- 命令行菜单界面，方便用户操作

#### 实现细节
系统使用Playwright库模拟浏览器操作，获取动态加载的基金排名数据。数据处理包括提取基金代码、基金名称、净值、增长率等信息，并存储到HDF5文件中。

#### 使用方法
1. 安装依赖：`pip install playwright pandas h5py`
2. 安装Playwright浏览器：`playwright install`
3. 运行 `python fetch_fbs_fund_ranking.py`

### 6. 货币基金数据获取 (fetch_hbx_fund_ranking.py)

#### 功能概述
从东方财富网获取货币基金的万份收益和7日年化收益率等详细数据，并支持将数据存储到HDF5文件中进行查询。

#### 主要功能
- 使用Playwright自动化浏览器获取货币基金数据
- 支持分页获取多页数据
- 提取包括万份收益、7日年化、14日年化、28日年化等多个时间维度的收益率数据
- 将数据存储到HDF5文件中
- 提供按基金代码查询功能
- 命令行菜单界面，方便用户操作

#### 实现细节
系统使用Playwright库模拟浏览器操作，获取货币基金排名数据。数据处理包括提取基金代码、基金名称、各种收益率指标等信息，并存储到HDF5文件中。

#### 使用方法
1. 安装依赖：`pip install playwright pandas h5py`
2. 安装Playwright浏览器：`playwright install`
3. 运行 `python fetch_hbx_fund_ranking.py`

### 7. 场内交易基金数据获取 (fetch_cnjy_fund_data.py)

#### 功能概述
从东方财富网获取场内交易基金的数据，包括净值、价格、折价率等信息，并支持将数据存储到HDF5文件中进行查询。

#### 主要功能
- 使用Playwright自动化浏览器获取场内交易基金数据
- 提取基金代码、基金名称、最新单位净值、最新累计净值、价格、折价率等信息
- 将数据存储到HDF5文件中
- 提供按基金代码查询功能
- 命令行菜单界面，方便用户操作

#### 实现细节
系统使用Playwright库模拟浏览器操作，获取场内交易基金数据。数据处理包括提取各种基金指标，并处理数值和百分比数据，然后存储到HDF5文件中。

#### 使用方法
1. 安装依赖：`pip install playwright pandas h5py`
2. 安装Playwright浏览器：`playwright install`
3. 运行 `python fetch_cnjy_fund_data.py`

### 8. 货币型基金数据获取 (fetch_currency_fund_data.py)

#### 功能概述
从东方财富网获取货币型基金的万份收益和7日年化收益率等核心数据，并支持将数据存储到HDF5文件中进行查询。

#### 主要功能
- 使用Playwright自动化浏览器获取货币型基金数据
- 提取基金代码、基金名称、万份收益、7日年化收益率等信息
- 将数据存储到HDF5文件中
- 提供按基金代码查询功能
- 命令行菜单界面，方便用户操作

#### 实现细节
系统使用Playwright库模拟浏览器操作，获取货币型基金数据。数据处理包括提取基金基本信息和收益率指标，并存储到HDF5文件中。

#### 使用方法
1. 安装依赖：`pip install playwright pandas h5py`
2. 安装Playwright浏览器：`playwright install`
3. 运行 `python fetch_currency_fund_data.py`

### 9. API测试工具 (test_api.py)

#### 功能概述
测试东方财富网基金数据API的连接和数据获取功能，主要用于调试和验证API响应。

#### 主要功能
- 发送请求到东方财富网基金排名API
- 打印API响应内容用于调试
- 解析API返回的基金数据
- 支持检查特定基金代码是否存在

#### 使用方法
1. 安装依赖：`pip install requests`
2. 运行 `python test_api.py`

## 存储方案

### HDF5数据存储

本项目主要使用HDF5格式存储基金数据，具有以下优势：

- **高效存储**：支持压缩和分块存储，节省空间
- **快速访问**：支持随机访问和部分读取，提高查询效率
- **结构化组织**：支持分层数据结构，便于管理不同类型的基金数据
- **跨平台支持**：可在不同操作系统和编程语言间共享数据

每个脚本将数据存储在独立的HDF5文件中，位于项目的data目录下：

- `Open_Fund_Ranking_Data.h5` - 开放式基金排名数据
- `FBS_Fund_Ranking_Data.h5` - 封闭式基金排名数据
- `HBX_Fund_Ranking_Data.h5` - 货币基金数据
- `CNJY_Fund_Data.h5` - 场内交易基金数据
- `Currency_Fund_Data.h5` - 货币型基金数据

### HDF5文件结构

HDF5文件采用以下结构组织数据：

1. 顶层包含一个"funds"组
2. 每个基金以其代码作为子组名
3. 基金的各项属性（如名称、收益率等）存储为该子组的属性
4. 文件根级别存储元数据（如最后更新时间、基金数量等）

## 依赖要求

| 脚本名称 | 主要依赖 | 安装命令 |
|---------|---------|--------|
| 1.Fund_Purchase_Status_Manager.py | pandas, numpy, akshare, tables | pip install pandas numpy akshare tables |
| 2.TDX_To_HDF5.py | pandas, numpy, h5py, psutil | pip install pandas numpy h5py psutil |
| 2.Read_HDF5_Data.py | pandas, numpy, h5py, plotly, openpyxl | pip install pandas numpy h5py plotly openpyxl |
| 3.Fetch_Fund_Data.py | requests, pandas, h5py, bs4 | pip install requests pandas h5py beautifulsoup4 |
| fetch_open_fund_ranking.py | requests, pandas, h5py | pip install requests pandas h5py |
| fetch_fbs_fund_ranking.py | playwright, pandas, h5py | pip install playwright pandas h5py |
| fetch_hbx_fund_ranking.py | playwright, pandas, h5py | pip install playwright pandas h5py |
| fetch_cnjy_fund_data.py | playwright, pandas, h5py | pip install playwright pandas h5py |
| fetch_currency_fund_data.py | playwright, pandas, h5py | pip install playwright pandas h5py |
| test_api.py | requests | pip install requests |
| quant_orchestrator.py | h5py, numpy, pandas, openpyxl, xlsxwriter | pip install h5py numpy pandas openpyxl xlsxwriter |

## 使用方法

### 基本使用流程

1. **安装依赖**：
   ```bash
   pip install -r requirements.txt
   ```
   
   或单独安装每个脚本所需的依赖。

2. **安装Playwright浏览器**（对于使用Playwright的脚本）：
   ```bash
   playwright install
   ```

3. **获取数据**：
   - 运行相应的数据获取脚本，如下载开放式基金数据：
     ```bash
     python fetch_open_fund_ranking.py
     ```
   - 在菜单中选择"1. 下载所有基金数据"

4. **查询数据**：
   - 在各脚本的菜单中选择"2. 查询基金数据"
   - 输入基金代码进行查询

### 配置参数

各脚本的主要配置参数：

| 参数 | 说明 | 默认值 | 配置位置 |
|-----|------|--------|--------|
| HDF5_PATH | HDF5数据文件路径 | ./data/[脚本名]_Data.h5 | 脚本顶部全局变量 |
| URL | 数据来源网站URL | 相应的东方财富网页面 | 脚本顶部全局变量 |
| PAGE_SIZE | 每页获取的基金数量 | 根据网站API设置 | 相关函数参数 |

## 10. 量化数据管理系统 (quant_orchestrator.py) 功能概述
统一管理所有基金数据模块，提供一键式数据下载、增量更新、数据查询和量化分析报表生成功能。

### 主要功能
- **统一数据管理**：集成所有基金模块，实现一键式数据获取
- **并行数据下载**：利用线程池提高数据获取效率
- **增量数据更新**：智能判断数据更新需求，避免重复计算
- **量化视图生成**：预计算12个量化指标，支持Excel报表输出
- **交互式菜单**：友好的命令行界面，支持多种操作模式
- **数据查询功能**：支持单个基金查询和多基金对比分析
- **高级量化分析**：提供专业的基金表现评估工具

### 命令行参数说明

#### 交互式模式
```bash
python quant_orchestrator.py
```

#### 非交互式模式
```bash
# 一键下载全部数据
python quant_orchestrator.py --all

# 下载指定模块数据
python quant_orchestrator.py --modules open,fbs,hbx

# 增量更新量化视图
python quant_orchestrator.py --update

# 生成Excel报表
python quant_orchestrator.py --report
```

### 量化视图预计算指标

系统自动计算以下12个量化指标并输出到Excel：

| 指标名称 | 说明 | 优化建议 |
|---------|------|--------|
| 夏普比率 | 风险调整后收益指标 | 越高越好，通常>1为优秀 |
| 年化收益率 | 年度化收益率 | 反映基金长期表现 |
| 波动率 | 收益波动性度量 | 越低表示风险越小 |
| 最大回撤 | 最大亏损幅度 | 越小越好，通常<20%为佳 |
| 卡玛比率 | 收益与最大回撤比 | 越高越好，>0.5为良好 |
| 索提诺比率 | 下行风险调整收益 | 仅考虑负向波动风险 |
| 胜率 | 正收益天数占比 | 越高越好，>50%为良好 |
| 盈亏比 | 平均盈利/平均亏损 | >1.5为优秀 |
| 流动性指标 | 交易活跃度评估 | 适合场内交易基金 |
| 持仓集中度 | 重仓股比例 | 评估分散化程度 |
| 风险敞口 | 市场敏感度 | 贝塔系数相关指标 |
| 信息比率 | 超额收益与主动风险比 | 反映主动管理能力 |

### Excel报表优化设计

Excel报表采用以下优化设计，提升数据对比效率：

1. **条件格式**：负收益指标用红色标识，便于快速识别风险
2. **自动筛选器**：表头添加筛选功能，支持多条件组合筛选
3. **排序功能**：支持按任意指标排序，快速找到最优基金
4. **数据透视表**：提供多维度分析视图
5. **公式计算**：关键复合指标自动计算
6. **数据验证**：确保数据完整性

### 使用方法

1. **基本使用**：
   ```bash
   python quant_orchestrator.py
   ```
   启动后会显示主菜单，可通过输入数字选择不同功能。

2. **依赖安装**：系统会自动检测并提示安装缺失的依赖
   ```bash
   # 手动安装所有依赖
   pip install h5py numpy pandas openpyxl xlsxwriter
   ```

3. **查看量化视图数据的方法**：
   - **方法一：生成Excel报表**：在主菜单中选择第5项"生成Excel报表"，系统会基于量化视图数据生成包含12个量化指标的Excel报表
   - **方法二：查询单个基金**：在主菜单中选择第4项"查询功能"，可查看单个基金的量化指标详情
   - **方法三：高级量化分析**：在主菜单中选择第9项"高级量化分析"，可进行更专业的基金表现评估
   - **方法四：命令行直接生成报表**：使用`python quant_orchestrator.py --report`命令直接生成Excel报表

   报表文件：`量化分析报告.xlsx`，包含所有基金的12个量化指标数据和优化的可视化设计

## 注意事项

1. **数据目录**：
   - 脚本会自动创建data目录（如果不存在）
   - 确保脚本有权限读写data目录
   - 量化视图数据存储在根目录的`quant_view.hdf5`文件中

2. **网络连接**：
   - 确保网络连接正常，特别是在获取数据时
   - 部分网站可能有访问频率限制，脚本中已添加适当延迟

3. **Playwright配置**：
   - 使用Playwright的脚本需要先安装浏览器：`playwright install`
   - 默认使用无头模式，可在脚本中将`headless`参数设置为`False`查看浏览器操作

4. **量化数据管理特别注意事项**：
   - **增量更新**：首次使用建议先执行全量下载（菜单选项1），之后再使用增量更新（菜单选项3）可提高效率
   - **数据一致性**：如发现数据异常，可尝试使用`force_full=True`参数重新生成量化视图数据
   - **性能优化**：处理大量基金数据时，建议使用64位Python并确保有足够内存
   - **报表查看**：生成的Excel报表包含条件格式和自动筛选器，建议使用Excel 2016或更高版本打开以获得最佳体验

## 项目特点

1. **模块化设计**：每个脚本专注于特定类型基金数据的获取和管理
2. **统一数据存储**：所有数据使用HDF5格式存储，便于统一管理和查询
3. **用户友好界面**：命令行菜单界面，简单易用
4. **错误处理**：包含完善的异常处理机制，确保程序稳定运行
5. **数据验证**：对获取的数据进行验证和清洗，确保数据质量

## 许可证

本项目采用MIT许可证。