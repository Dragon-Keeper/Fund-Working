# 基金数据爬取与HDF5存储系统

## 项目简介

本项目提供了一个从东方财富网爬取基金数据并将其存储到HDF5数据库的完整解决方案。系统支持多线程并行爬取、错误处理、数据验证和高效存储，能够快速获取并保存大量基金的最新净值、累计净值、日增长率等关键数据。

## 文件结构

项目包含以下主要文件：

- `Fetch_Fund_Data.py`：主程序，实现基金数据爬取和HDF5存储功能
- `README_Fetch_Fund_Data.md`：本说明文件

## 主要功能

### 1. 数据爬取功能

- **自动获取总页数**：系统会自动从东方财富网获取基金数据的总页数
- **多线程并行爬取**：使用线程池提高爬取效率，线程数可自定义
- **断点续爬与重试机制**：当遇到网络问题时，会自动重试，避免数据丢失
- **进度显示**：实时显示爬取进度、成功失败页数和耗时

### 数据解析功能

- **智能解析**：从页面HTML中提取基金数据，包括基金代码、名称、净值、增长率等
- **数据清洗**：处理缺失值和格式不一致的数据
- **数据类型转换**：将字符串数据转换为适当的数值类型

### 核心解析函数说明

#### 1. get_raw_page_content(page_num)
获取指定页面的原始HTML内容。
- **功能**：发送HTTP请求获取基金数据页面，处理编码问题和网络错误
- **参数**：page_num - 要获取的页面编号
- **返回值**：页面HTML内容（字符串）或None（如果获取失败）
- **特点**：
  - 实现3次自动重试机制
  - 支持自动检测和处理UTF-8/GBK编码
  - 使用指数退避策略（2秒后重试，再4.5秒后重试）
  - 详细的日志记录和错误处理

#### 2. fetch_page_data(page_num)
获取并解析指定页面的基金数据。
- **功能**：协调页面获取和数据解析流程
- **参数**：page_num - 要获取的页面编号
- **返回值**：元组(page_num, fund_data_list) - 页面编号和解析出的基金数据列表
- **处理流程**：
  1. 调用get_raw_page_content获取页面内容
  2. 调用parse_fund_data解析页面内容
  3. 返回页面编号和解析出的基金数据

#### 3. parse_fund_data(page_content)
解析页面HTML内容，提取基金数据。
- **功能**：从HTML中提取结构化的基金数据
- **参数**：page_content - 页面HTML内容（字符串）
- **返回值**：基金数据列表，每个元素是包含14个字段的字典
- **解析策略**：采用四阶段解析策略
  1. **数据部分提取**：使用3种不同的正则表达式模式尝试提取数据部分
  2. **多方法解析**：实现3种解析方法，自动选择最优结果
     - 方法1：使用精确正则表达式匹配每个基金数据项
     - 方法2：手动解析，基于引号和括号状态跟踪提取数据项
     - 方法3：按23个字段分割，考虑引号内逗号的安全分割
  3. **数据字段映射**：将解析出的23个原始字段映射到14个标准字段
  4. **数据类型处理**：将字符串数据转换为适当的数值类型，处理空值情况

### 数据字段映射关系

系统从原始数据中提取23个字段，并映射为以下14个标准字段：

| 标准字段 | 原始字段索引 | 说明 | 数据类型 |
|--------|------------|------|---------|
| fund_code | 0 | 基金代码 | 字符串 |
| fund_name | 1 | 基金名称 | 字符串 |
| current_unit_nav | 3 | 最新交易日单位净值 | 浮点数 |
| current_accumulated_nav | 4 | 最新交易日累计净值 | 浮点数 |
| previous_unit_nav | 5 | 上一交易日单位净值 | 浮点数 |
| previous_accumulated_nav | 6 | 上一交易日累计净值 | 浮点数 |
| daily_growth_value | 7 | 日增长值 | 浮点数 |
| daily_growth_rate | 8 | 日增长率 | 浮点数 |
| purchase_status | 9 | 申购状态 | 字符串 |
| redemption_status | 10 | 赎回状态 | 字符串 |
| actual_fee_rate | 17 | 实际手续费率 | 字符串 |
| original_fee_rate | 20 | 原始手续费率 | 字符串 |
| current_date | 21 | 最新交易日日期 | 字符串 |
| previous_date | 22 | 上一交易日日期 | 字符串 |

### 3. 数据存储功能

- **HDF5格式存储**：使用高效的HDF5格式存储数据，支持快速读写
- **按基金代码组织**：数据按基金代码分类存储，便于后续查询
- **元数据记录**：存储基金的各种属性信息和更新时间
- **增量更新**：支持对已有基金数据进行更新

### 4. 数据验证功能

- **完整性检查**：验证爬取数据的数量和质量
- **示例数据验证**：检查是否包含特定的示例基金数据
- **统计信息**：提供有效数据和无效数据的统计

## 技术特点

- **高效性**：多线程爬取和批处理存储，提高处理效率
- **可靠性**：完善的错误处理和重试机制，确保数据完整性
- **易用性**：提供简单的命令行界面，便于操作
- **可扩展性**：模块化设计，便于后续功能扩展
- **日志系统**：详细的日志记录，便于调试和监控

## 安装与使用

### 环境要求

- Python 3.6+ 
- 依赖包：pandas, numpy, h5py, requests

### 自动安装依赖

程序会自动检查并安装所需的依赖包，无需手动安装。

### 使用方法

1. **完整爬取模式**：运行主程序，爬取所有页面的基金数据
   ```
   python Fetch_Fund_Data.py
   ```

2. **数据存储位置**：爬取的基金数据会存储在`data/Fund_NAV.h5`文件中

## 数据字段说明

系统会爬取并存储以下基金数据字段：

| 字段名 | 说明 | 数据类型 |
|-------|------|---------|
| fund_code | 基金代码 | 字符串 |
| fund_name | 基金名称 | 字符串 |
| current_unit_nav | 最新交易日单位净值 | 浮点数 |
| current_accumulated_nav | 最新交易日累计净值 | 浮点数 |
| previous_unit_nav | 上一交易日单位净值 | 浮点数 |
| previous_accumulated_nav | 上一交易日累计净值 | 浮点数 |
| daily_growth_value | 日增长值 | 浮点数 |
| daily_growth_rate | 日增长率 | 浮点数 |
| purchase_status | 申购状态 | 字符串 |
| redemption_status | 赎回状态 | 字符串 |
| actual_fee_rate | 实际手续费率 | 字符串 |
| original_fee_rate | 原始手续费率 | 字符串 |
| current_date | 最新交易日日期 | 字符串 |
| previous_date | 上一交易日日期 | 字符串 |
| last_updated | 数据更新时间 | 字符串 |

## 注意事项

1. **网络请求限制**：请合理设置线程数，避免过快的请求导致IP被限制
2. **数据更新频率**：东方财富网的基金数据通常在每个交易日的18:00后更新
3. **存储空间**：爬取所有113页数据大约需要几十MB的存储空间
4. **异常处理**：程序设计了完善的异常处理机制，但在极端情况下仍可能出现问题

## 扩展建议

1. 添加定期自动更新功能
2. 增加更多的数据可视化分析功能
3. 支持导出数据到Excel、CSV等其他格式
4. 实现数据查询和筛选功能
5. 添加更多数据源，如天天基金网、雪球等

## 关联功能

本模块与以下系统功能紧密相关：

- **量化分析功能**：本模块爬取的基金基础数据是量化分析功能的重要数据源
- **HDF5数据管理**：爬取的数据通过统一的HDF5格式存储，便于后续分析处理
- **Excel报表生成**：基于爬取数据生成的量化分析结果最终通过Excel报表呈现

## 更新记录

- 优化多线程爬取机制，提高数据获取效率
- 完善错误处理和重试机制，确保数据完整性
- 增强与量化分析功能的集成，提供更完整的数据分析流程
- 支持与量化数据管理系统的无缝对接，实现一键式数据处理

## 问题反馈

如有任何问题或建议，请记录详细的错误信息和操作步骤，以便进行问题排查和修复。