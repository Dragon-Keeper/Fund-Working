# 基金量化分析系统

## 概述
本模块是一个基于完整净值时间序列数据的基金量化分析系统，提供严格、准确的基金量化指标计算功能。系统摒弃了之前的简化近似计算方法，采用严格的统计分析方法，确保计算结果的准确性与可靠性，并提供统计显著性检验功能。

## 功能特性

### 核心量化指标计算

1. **年化收益率**：基于完整净值时间序列数据计算，考虑实际投资期限
2. **上涨日数/月数/季数比例**：准确统计上涨周期比例
3. **日涨跌幅标准差**：反映基金短期波动情况
4. **月涨跌幅标准差**：反映基金中期波动情况
5. **最大回撤率**：计算基金净值从峰值到谷值的最大损失比率
6. **第二大回撤率**：计算第二大的净值回撤比率
7. **夏普率**：衡量风险调整后的收益
8. **卡玛比率**：衡量年化收益率与最大回撤的比值
9. **索提诺比率**：与夏普率类似，但只考虑下行风险
10. **信息比率**：衡量超额收益与跟踪误差的比值

### 数据分析与处理

1. **数据清洗与异常值处理**：使用IQR方法识别和过滤异常值
2. **时间范围筛选**：支持自定义分析时间范围
3. **统计显著性检验**：提供t检验、置信区间和正态性检验等统计分析
4. **Excel导出功能**：将分析结果导出为Excel文档，包含条件格式设置

### 用户界面

1. **交互式菜单系统**：提供友好的命令行交互界面
2. **自定义HDF5文件路径**：支持用户指定数据文件位置
3. **进度显示**：在批量分析时显示进度信息

## 技术实现

### 数据处理流程

1. **数据读取**：直接从HDF5文件读取完整的基金净值时间序列数据
2. **数据清洗**：处理缺失值和异常值，确保数据质量
3. **指标计算**：基于清洗后的数据计算各项量化指标
4. **多源数据补充**：通过多个数据源获取基金的详细信息和历史表现数据
5. **统计检验**：对计算结果进行统计显著性检验
6. **结果导出**：将分析结果导出为Excel文档，支持自定义文件名格式

### 关键算法

1. **年化收益率计算**：
   ```python
   # 基于完整净值时间序列计算年化收益率
   total_return = (end_price - start_price) / start_price
   years_diff = days_diff / 365.0
   annualized_return = ((1 + total_return) ** (1 / years_diff)) - 1
   ```

2. **最大回撤率计算**：
   ```python
   # 计算累计净值和累计最大值
   cumulative_nav = df['close'] / df['close'].iloc[0]
   running_max = cumulative_nav.cummax()
   # 计算回撤率并找出最大值
   drawdown = (cumulative_nav - running_max) / running_max
   max_drawdown = drawdown.min()
   ```

3. **统计显著性检验**：
   ```python
   # 对年化收益率进行t检验
   t_stat, p_value = stats.ttest_1samp(daily_returns, 0, alternative='greater')
   # 计算95%置信区间
   confidence_interval = stats.t.interval(0.95, len(daily_returns)-1, 
                                        loc=mean_return, scale=std_error)
   ```

## 独立运行说明

本模块可以独立运行，也可以通过`quant_orchestrator.py`调用。运行时，系统会自动从默认路径或用户指定的路径读取HDF5数据文件，并从多个数据源获取补充信息。

## 使用方法

### 前提条件

1. 确保已安装必要的Python库：
   ```
   numpy, pandas, h5py, matplotlib, scipy, xlsxwriter
   ```

2. 确保存在有效的HDF5基金数据文件，系统会从以下文件获取数据：
   ```
   ./data/All_Fund_Data.h5
   ./data/CNJY_Fund_Data.h5
   ./data/Currency_Fund_Data.h5
   ./data/HBX_Fund_Ranking_Data.h5
   ./data/Fetch_Fund_Data.h5
   ./data/Open_Fund_Ranking_Data.h5
   ```

2. 确保存在有效的HDF5基金数据文件，默认路径为：
   ```
   ./data/All_Fund_Data.h5
   ```

### 启动系统

直接运行`quant_analysis.py`文件：

```bash
python quant_analysis.py
```

### 功能选择

系统提供以下功能选项：

1. **计算并导出所有基金量化指标**：对所有基金进行批量分析并导出结果
2. **计算并导出指定基金量化指标**：分析单个基金并导出结果
3. **自定义HDF5文件路径**：指定数据文件的位置
4. **退出系统**：关闭程序

### 操作示例

#### 分析所有基金

1. 选择功能选项 `1`
2. 输入起始日期（格式：YYYYMMDD，如 `20230101`，或直接按回车使用默认时间范围）
3. 系统会开始分析所有基金并显示进度
4. 分析完成后，结果将导出为Excel文件

#### 分析指定基金

1. 选择功能选项 `2`
2. 输入起始日期（格式：YYYYMMDD，或直接按回车使用默认时间范围）
3. 输入基金代码（如 `161725`）
4. 系统会分析指定基金
5. 分析完成后，结果将导出为Excel文件

## 结果解释

### 量化指标说明

- **年化收益率**：基金在一年时间内的平均收益率，考虑了复利效应
- **夏普率**：每单位风险所获得的超额收益，数值越高表示风险调整后收益越好
- **卡玛比率**：年化收益率与最大回撤的比值，反映承受单位回撤所获得的收益
- **最大回撤率**：基金净值从最高点到最低点的最大跌幅，衡量基金的下行风险

### 统计检验结果

- **收益率显著性**：检验收益率是否显著大于0（p值小于0.05表示显著）
- **年化收益率95%置信区间**：表示在95%置信水平下，年化收益率的可能范围
- **数据正态性**：检验收益率数据是否符合正态分布，对一些依赖正态分布假设的分析方法有参考价值

## 注意事项

1. **数据质量**：分析结果的准确性高度依赖于HDF5数据文件的质量和完整性

2. **时间范围**：建议使用足够长的时间范围（至少1年）进行分析，以获得更可靠的结果

3. **样本量**：当样本量不足30个交易日时，统计显著性检验结果可能不可靠

4. **异常值处理**：系统已内置异常值处理机制，但极端市场条件下的数据仍可能影响分析结果

5. **基准指数**：当前版本的信息比率计算中，基准收益率简化为0，实际应用中应使用合适的基准指数

## 系统要求

- Python 3.7 或更高版本
- 必要的Python库：numpy, pandas, h5py, matplotlib, scipy, xlsxwriter
- 建议系统内存：4GB或以上（取决于分析的基金数量和数据量）

## 常见问题

### Q: 程序运行时提示"未找到基金数据"怎么办？
A: 请确保HDF5数据文件存在，且路径正确。可以通过功能选项3自定义文件路径。

### Q: 分析结果中部分指标显示为N/A是什么原因？
A: 这通常是因为该基金的数据不足或存在缺失值，导致无法计算相应指标。

### Q: 如何提高分析结果的准确性？
A: 使用更长的时间范围、确保数据质量、考虑使用多个指标综合评估基金表现。

### Q: 可以同时分析多个指定基金吗？
A: 当前版本暂不支持同时分析多个指定基金，您可以选择分析所有基金，然后在导出的Excel文件中筛选。

## 更新日志

### v2.1.0
- 增强多数据源获取能力，支持从6个HDF5数据源获取基金信息
- 添加字段映射系统，确保不同数据源的字段正确映射到统一表头
- 优化数据获取逻辑，提高数据完整性和准确性
- 修改Excel导出文件名规则，支持自定义格式
  - 指定基金分析结果：基金代码_量化分析结果_YYYYMMDD_HHMMSS.xlsx
  - 所有基金分析结果：All_Fund_量化分析结果_YYYYMMDD_HHMMSS.xlsx
- 增加数据获取过程的日志输出，便于调试和监控

### v2.0.0
- 完全重构为基于完整净值时间序列数据的严格计算版本
- 增加数据清洗和异常值处理功能
- 实现统计显著性检验
- 支持独立运行或通过quant_orchestrator.py调用
- 优化Excel导出功能，增强数据可视化效果
- 完善用户交互界面

### v1.0.0
- 初始版本，基于简化计算方法实现量化分析功能