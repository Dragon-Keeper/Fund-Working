# 通达信基金数据转HDF5工具

## 功能概述

通达信基金数据转HDF5工具是一个高效的数据转换工具，专门用于将通达信软件生成的.day格式基金数据文件转换为HDF5格式并存储。该工具采用多种优化技术，包括多线程并行处理、内存映射和批量写入等，能够快速处理大量基金数据文件，实现从原始格式到高效查询格式的转换，为后续的数据分析和查询提供基础。

## 系统特点

- **高效数据处理**：采用内存映射技术和多线程并行处理，显著提升处理速度
- **智能资源管理**：自动检测系统资源并动态调整线程数和批量大小
- **断点续传功能**：记录处理状态，支持从中断点继续处理
- **安全数据存储**：使用临时文件和文件锁确保数据写入安全
- **详细进度显示**：实时显示处理进度、速度和预计剩余时间
- **完善的错误处理**：详细记录错误信息，支持错误文件单独处理
- **目录路径智能检测**：自动检查源目录是否存在，不存在时提供交互式输入功能

## 主要功能

### 1. 数据读取与解析

- **内存映射解析**：使用内存映射技术高效读取.day文件
- **二进制数据处理**：解析通达信.day文件的二进制格式，提取基金数据
- **文件哈希值计算**：计算文件哈希值用于验证和缓存

### 2. 多线程并行处理

- **动态线程分配**：根据系统CPU核心数自动调整线程数
- **工作队列管理**：使用队列分配文件处理任务
- **线程安全处理**：确保多线程环境下的数据一致性

### 3. 批量数据写入

- **优化的批量写入**：批量处理数据写入，减少I/O操作
- **流式处理**：采用流式处理模式，降低内存占用
- **文件锁机制**：使用文件锁确保数据写入的安全性

### 4. 状态管理与恢复

- **处理状态保存**：定期保存处理状态到缓存文件
- **断点续传**：支持从中断处继续处理，无需重新开始
- **错误文件记录**：记录处理失败的文件，便于后续单独处理

## 技术实现

### 核心函数

#### 1. 系统与环境管理

- **check_dependencies()**：检查并安装必要的依赖库
- **get_system_info()**：获取系统信息，包括CPU核心数和内存大小
- **get_optimal_threads()**：根据系统资源计算最优线程数
- **create_directories()**：创建必要的目录结构

#### 2. 文件处理与解析

- **calculate_file_hash()**：计算文件的哈希值，用于验证和缓存
- **parse_day_file_with_memory_map()**：使用内存映射技术解析.day文件
  - 打开文件并创建内存映射
  - 按照通达信文件格式提取数据
  - 转换为NumPy数组以提高处理效率

#### 3. 数据处理与增强

- **process_single_file_enhanced()**：增强版的单文件处理函数
  - 增强错误恢复机制
  - 详细的错误日志记录
  - 支持最小日期过滤
  - 文件处理计时和性能监控

#### 4. 数据存储

- **save_to_storage_streaming()**：流式处理数据写入函数
  - 使用临时文件和文件锁确保安全合并
  - 分批处理数据以减少内存占用
  - 支持进度跟踪和状态保存

- **batch_write_to_hdf5_optimized()**：优化版的批量写入函数
  - 批量将数据写入HDF5文件
  - 优化数据组织和存储结构
  - 支持按基金代码分类存储

#### 5. 并行处理与进度管理

- **process_all_day_files_optimized()**：优化版的文件批量处理函数
  - 使用线程池并行处理多个文件
  - 管理处理队列和结果收集
  - 处理异常情况和任务取消

- **update_progress_optimized()**：优化版的进度更新函数
  - 实时显示处理进度
  - 计算并显示处理速度
  - 估计剩余处理时间

- **auto_batch_write_optimized()**：自动批量写入线程函数
  - 监控写入队列并自动批量写入
  - 定期保存处理状态
  - 处理写入错误和异常情况

## 使用方法

### 基本操作流程

1. 运行程序：`python TDX_To_HDF5.py`
2. 系统会自动检查并安装必要的依赖
3. 系统会自动检查配置的源目录是否存在，如果不存在，会提示输入有效的目录路径：
   
   ```
   警告：源目录 'D:\SoftWare\TDX\vipdoc\ds\lday' 不存在或无法访问
   请输入通达信基金数据文件(.day)所在目录路径，或输入'q'退出程序: 
   ```
   
   输入有效的目录路径后继续，或输入'q'退出程序
4. 根据提示输入相关参数：

   ```
   通达信基金数据转HDF5工具
   ------------------------
   请输入最小日期（格式：YYYYMMDD，默认为提取所有数据）: 
   
   请选择线程数模式：
   1. 单线程
   2. auto自动计算最佳线程数
   3. 退出
   请输入选择 (1-3): 
   ```

4. 等待数据处理完成
5. 查看处理结果统计

### 参数说明

#### 必需参数

工具可以不提供任何参数运行，使用默认设置。

#### 可选参数

- **最小日期**：格式为YYYYMMDD，用于筛选数据，只处理日期大于等于该值的数据
  - 例如：输入20200101表示只处理2020年1月1日及以后的数据
  - 直接回车表示提取所有数据

- **线程数选择**：
  - 选择1：使用单线程处理
  - 选择2：让系统自动计算最优线程数
  - 选择3：退出程序

## 配置选项

工具内部有以下可配置选项，可以根据需要修改：

```python
# 源文件目录
source_dir = r"D:\SoftWare\TDX\vipdoc\ds\lday"  # 通达信.day文件目录
# 注意：程序会自动检查该目录是否存在，如果不存在，会提示用户输入有效的目录路径

# 存储文件路径
storage_file = os.path.join("data", "All_Fund_Data.h5")  # HDF5存储文件路径

# 缓存目录
cache_dir = "cache"

# 批量写入大小
batch_size = 10000  # 默认批量写入大小

# 状态保存间隔
status_save_interval = 60  # 秒
```

## 返回值与输出

### 程序输出

程序运行过程中会输出以下信息：

- 系统信息和资源配置
- 处理进度条
- 处理速度和预计剩余时间
- 错误文件信息（如有）
- 最终处理统计：
  - 处理的文件总数
  - 成功处理的文件数
  - 处理失败的文件数
  - 总耗时
  - 处理的股票数量
  - 数据记录总数

### 生成的文件

- **HDF5数据文件**：`data/All_Fund_Data.h5`
- **处理状态文件**：`cache/processing_status.json`
- **错误文件列表**：`cache/errors/error_files.json`

## 注意事项

1. **通达信数据准备**：
   - 确保通达信软件已安装并下载了基金历史数据
   - 确认source_dir路径指向正确的.day文件目录

2. **系统资源要求**：
   - 处理大量数据时，建议系统有足够的内存和CPU资源
   - 自动线程计算会根据系统资源进行优化，但在低配置系统上可能仍需手动设置较小的线程数

3. **存储空间**：
   - 确保目标磁盘有足够的空间存储HDF5文件
   - 临时文件处理期间可能需要额外的存储空间

4. **中断与恢复**：
   - 程序支持断点续传，意外中断后可以重新运行继续处理
   - 处理状态会定期保存，中断后不会丢失所有进度

5. **错误处理**：
   - 处理失败的文件会记录到cache/errors目录
   - 可以单独处理错误文件或检查文件是否损坏

6. **性能优化**：
   - 对于SSD存储，处理速度会更快
   - 避免在处理过程中进行其他高I/O操作

## 常见问题与解决方案

### 1. 找不到通达信数据文件

- 确认通达信软件已安装并下载了基金数据
- 修改代码中的source_dir变量指向正确的目录
- 检查通达信软件的数据下载设置

### 2. 内存不足错误

- 减少线程数
- 减小batch_size值
- 增加系统内存
- 使用最小日期参数筛选数据范围

### 3. HDF5文件写入错误

- 确保目标目录存在且有写入权限
- 检查是否有其他程序正在访问该文件
- 尝试以管理员权限运行程序

### 4. 处理速度过慢

- 使用'auto'参数让系统自动计算最优线程数
- 考虑使用SSD存储
- 筛选数据范围，只处理需要的日期范围

## 系统要求

- **操作系统**：Windows、Linux或macOS
- **Python版本**：Python 3.6或更高版本
- **依赖库**：
  - pandas：数据处理
  - numpy：数值计算
  - h5py：HDF5文件操作
  - psutil：系统资源监控
  - tqdm：进度条显示

## 性能优化建议

1. **硬件优化**：
   - 使用SSD存储可显著提高I/O性能
   - 增加内存可减少频繁的磁盘交换
   - 多核CPU有助于并行处理

2. **参数调整**：
   - 根据系统配置调整线程数
   - 测试不同的batch_size值找到最优配置
   - 使用最小日期参数限制数据范围

3. **数据管理**：
   - 定期清理cache目录中的旧状态文件
   - 归档不常用的历史数据
   - 考虑对HDF5文件进行压缩以节省空间

## 扩展与自定义

工具设计考虑了扩展性，可以通过以下方式进行自定义：

1. **支持更多文件格式**：修改parse_day_file_with_memory_map函数以支持其他格式
2. **增强数据处理**：在process_single_file_enhanced函数中添加额外的数据处理逻辑
3. **自定义存储结构**：修改batch_write_to_hdf5_optimized函数以调整HDF5文件结构
4. **添加新的分析功能**：在数据转换的同时执行初步分析

## 联系与支持

如有任何问题或建议，请通过以下方式联系开发者：

- 邮箱：[example@domain.com]
- GitHub：[GitHub仓库链接]

---

© 2023 通达信基金数据转HDF5工具 - 保留所有权利